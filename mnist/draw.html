<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Handwritten Digit</title>
    <style>
        body {
            margin: 0;
            padding: 2rem;
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            color: #333;
        }

        h1 {
            margin: 1rem auto;
            font-size: 1.75rem;
            border-bottom: 2px dashed #333;
            max-width: fit-content;
        }

        .container {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }

        .box {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            max-width: 100%;
            height: auto;
        }

        #drawCanvas {
            cursor: crosshair;
        }

        #controls {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
        }

        button {
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        button:hover {
            background-color: #0c72df;
            transform: translateY(-1px);
        }

        #results {
            font-size: 1.1rem;
            padding: 1rem;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 150px;
        }

        h3 {
            margin-bottom: 1rem;
        }

        #neuralNetCanvasYesInput {
            display: block;
        }

        #neuralNetCanvasNoInput {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                align-items: stretch;
            }

            .box {
                width: 100%;
                max-width: 100%;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <h1>Neural Network to Predict Handwritten Digits</h1>
    <div class="container">
        <div class="box">
            <h3>Draw a Number</h3>
            <canvas id="drawCanvas" width="140" height="140"></canvas>
            <div id="controls">
                <button onclick="clearCanvas()">Clear</button>
                <button onclick="processImage()">Predict</button>
            </div>
        </div>
        <div class="box">
            <canvas id="neuralNetCanvasYesInput" width="600" height="400"></canvas>
            <canvas id="neuralNetCanvasNoInput" width="600" height="400"></canvas>
            <div id="controls">
                <button onclick="toggleCanvas()"><span id="canvasToggleText">Hide</span> Input layer</button>
            </div>
        </div>
        <div class="box">
            <div id="results">
                <div>Prediction: <strong><span id="pred">0</span></strong></div>
                <div>Confidence: <strong><span id="conf">00.00%</span></strong></div>
            </div>
        </div>
    </div>

    <script src="./webModel.js"></script>
    <script>
        let nn;
        const neuralNetCanvasYesInput = document.getElementById('neuralNetCanvasYesInput');
        const neuralNetCanvasNoInput = document.getElementById('neuralNetCanvasNoInput');
        let currentSelectedCanvas = neuralNetCanvasYesInput;
        // caching currentSelectedCanvas for animation support - 4 later

        (async () => {
            await initNeuralNetwork();
        })();

        async function initNeuralNetwork() {
            try {
                const response = await fetch('./dump/WebModelNew.json');
                // const response = await fetch('../iris/model.json');
                const obj = await response.json();
                nn = new NeuralNetwork(obj.layers);
                //defaluts =>
                // drawNN(canvasSelector, ignoreInput = false, cwidth = 600, cheight = 400, weightLineWidth = 0.5, nodeRadius = 6)
                nn.drawNN("#neuralNetCanvasYesInput", false, '', '', weightLineWidth = 0.75);
                nn.drawNN("#neuralNetCanvasNoInput", true, '', '', weightLineWidth = 0.75);
            } catch (error) {
                console.log(error)
            }
        }

        // CANVAS_DRAWING_LOGIG
        const drawCanvas = document.getElementById('drawCanvas');
        const ctx = drawCanvas.getContext('2d');
        let drawing = false;

        function getPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            if (e.touches) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const { x, y } = getPos(e);
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();
        }

        // Mouse events
        drawCanvas.addEventListener('mousedown', (e) => { drawing = true; draw(e); });
        drawCanvas.addEventListener('mouseup', () => drawing = false);
        drawCanvas.addEventListener('mouseout', () => drawing = false);
        drawCanvas.addEventListener('mousemove', draw);

        // Touch events
        drawCanvas.addEventListener('touchstart', (e) => { drawing = true; draw(e); });
        drawCanvas.addEventListener('touchend', () => drawing = false);
        drawCanvas.addEventListener('touchcancel', () => drawing = false);
        drawCanvas.addEventListener('touchmove', draw);

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
        }

        clearCanvas();

        function processImage() {
            const smallCanvas = document.createElement('canvas');
            smallCanvas.width = 28;
            smallCanvas.height = 28;
            const smallCtx = smallCanvas.getContext('2d');

            // Downscale
            smallCtx.drawImage(drawCanvas, 0, 0, 28, 28);

            const imageData = smallCtx.getImageData(0, 0, 28, 28);
            const data = imageData.data;
            const brightnessArray = [];

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = Math.abs(255 - Math.round(0.299 * r + 0.587 * g + 0.114 * b)) / 255.0;
                brightnessArray.push(brightness);
            }

            const prediction = nn.predict(brightnessArray);
            const predictedDigit = prediction.indexOf(Math.max(...prediction));
            const confidence = (Math.max(...prediction) * 100).toFixed(2);

            document.getElementById('pred').textContent = predictedDigit;
            document.getElementById('conf').textContent = confidence + "%";

            if (confidence >= 75.0) {
                document.getElementById('conf').style.color = 'hsl(120deg, 50%, 50%)';
            } else if (confidence >= 50) {
                document.getElementById('conf').style.color = 'hsl(60deg, 50%, 50%)';
            } else {
                document.getElementById('conf').style.color = 'hsl(0deg, 50%, 50%)';
            }

            // console.log('Brightness Array (28x28):', brightnessArray);
            // console.log(`Prediction: ${predictedDigit}, Confidence: ${confidence}`);
        }

        function toggleCanvas() {
            const canvasToggleText = document.getElementById('canvasToggleText');

            if (canvasToggleText.innerText == "Hide") {
                canvasToggleText.innerHTML = "Show";
                neuralNetCanvasYesInput.style.display = 'none';
                neuralNetCanvasNoInput.style.display = 'block';
                currentSelectedCanvas = neuralNetCanvasNoInput;
            } else {
                canvasToggleText.innerText = "Hide";
                neuralNetCanvasYesInput.style.display = 'block';
                neuralNetCanvasNoInput.style.display = 'none';
                currentSelectedCanvas = neuralNetCanvasYesInput;
            }
            // console.log(currentSelectedCanvas);
        }
    </script>
</body>

</html>